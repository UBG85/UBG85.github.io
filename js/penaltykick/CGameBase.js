var s_iCurState,s_oGameKeeper,s_oGameStriker,CGameBase=function(i){this._bExtraPenalty,this._iPlayerGoals,this._iOpponentGoals,this._iNumKicks,this._iCurLevel,this._iLevelScore,this._iTotScore,this._iMultiplier,this._iRemainingPlayerKicks,this._iRemainingOpponentKicks,this._aHistoryPlayer,this._aHistoryOpponent,this._aResults,this._oInterface,this._oCurScenario,this._oContainerGame,this._oContainer,this._oResultPanel,this._oQuizPanel,this._oQuestionGenerator,this._iCurStage,this._bBotLastAnswerWrong,this._szCurQuizOperation,this._iIDTimeout,this._bBonusShot};CGameBase.prototype._init=function(i){if($(s_oMain).trigger("start_session"),$(s_oMain).trigger("start_level",i),this._iCurLevel=i,this.reset(),this._aResults=new Array,s_bMobile)for(var t=0;t<BALL_FORCE_Y.length;t++)BALL_FORCE_Y[t]*=BALL_VELOCITY_MULTIPLIER,BALL_FORCE_Z[t].min/=BALL_VELOCITY_MULTIPLIER+.1,BALL_FORCE_Z[t].max*=BALL_VELOCITY_MULTIPLIER+.1,BALL_FORCE_X[t]*=BALL_VELOCITY_MULTIPLIER;this._oContainer=new createjs.Container,s_oStage.addChild(this._oContainer);var e=new createjs.Shape;e.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT),this._oContainer.addChild(e),this._oContainerGame=new createjs.Container,this._oContainer.addChild(this._oContainerGame),this._oContainerFG=new createjs.Container,s_oStage.addChild(this._oContainerFG),this._oInterface=new CInterface(this._iCurLevel,this._iTotScore,this._oContainer,this._oContainerFG),this._oQuizPanel=new CQuizPanel(this._oContainer),this._oResultPanel=new CResultPanel(this._iCurLevel,this._oContainer),this._oQuestionGenerator=new CQuestionGenerator},CGameBase.prototype.reset=function(){s_bMultiplayer||1===this._iCurLevel?this._iTotScore=0:this._iTotScore=s_oMain.getScoreTillLevel(this._iCurLevel),this._bBonusShot=!1,console.log("this._bBonusShot:"+this._bBonusShot),this._iCurStage=0,this._bExtraPenalty=!1,s_iCurState=STRIKER_MODE,this._iPlayerGoals=0,this._iLevelScore=0,this._iOpponentGoals=0,this._iNumKicks=1,this._iMultiplier=1,this._iRemainingPlayerKicks=NUM_KICKS/2,this._iRemainingOpponentKicks=NUM_KICKS/2,this._aHistoryPlayer=new Array,this._aHistoryOpponent=new Array,refreshSettings(s_iCurState),stopSound("soundtrack"),playSound("crowd",CROWD_GENERAL_VOLUME,!0)},CGameBase.prototype.unload=function(){this._oInterface.unload(),s_oStage.removeChild(this._oContainer),this._oQuizPanel.unload(),clearTimeout(this._iIDTimeout),s_oGame=null,this._oCurScenario.unload()},CGameBase.prototype.endShotPlayer=function(i,t,e){i?(this._aHistoryPlayer.push(1),this._iPlayerGoals++,this._bExtraPenalty):(this._iMultiplier=1,this._bExtraPenalty,this._aHistoryPlayer.push(0)),e?i&&this._oInterface.setBonusGoal(PLAYER):(i||this._iRemainingPlayerKicks--,this._oInterface.refreshKicks(PLAYER,this._aHistoryPlayer)),this._iRemainingPlayerKicks--,this._iRemainingPlayerKicks<0&&(this._iRemainingPlayerKicks=0),this._showResult(i,t)},CGameBase.prototype.endShotOpponent=function(i,t,e){i?(this._aHistoryOpponent.push(1),this._iOpponentGoals++,this._iMultiplier=1,this._bExtraPenalty):(this._aHistoryOpponent.push(0),this._bExtraPenalty),e?i&&this._oInterface.setBonusGoal(OPPONENT):(i||this._iRemainingOpponentKicks--,this._oInterface.refreshKicks(OPPONENT,this._aHistoryOpponent)),this._iRemainingOpponentKicks--,this._iRemainingOpponentKicks<0&&(this._iRemainingOpponentKicks=0),this._showResult(i,t)},CGameBase.prototype._showResult=function(i,t){var e=TEXT_MISSED;i?e=TEXT_GOAL:t&&(e=TEXT_SAVED),this._oInterface.refreshScoreBoard(e,this._iPlayerGoals,this._iOpponentGoals),this._oResultPanel.show(e,this._iPlayerGoals,this._iOpponentGoals)},CGameBase.prototype.hideResult=function(){this._oQuizPanel.hide(),this._oResultPanel.hide()},CGameBase.prototype.generateTheQuizFromCurOperation=function(){return this._szCurQuizOperation?this._oQuestionGenerator.getNewMathQuestionFromOperation(this._szCurQuizOperation):this.generateTheQuiz()},CGameBase.prototype.generateTheQuiz=function(){var i=this._oQuestionGenerator.getNewMathQuestion();return this.setCurQuizOperation(i.operation),i},CGameBase.prototype.showTheQuiz=function(i){var t=this.getQuizTime();this._oQuizPanel.show(i.cypher,i.operation,i.correctanswer,i.answers,t),this._oResultPanel.animUp(),this._oQuizPanel.animDown()},CGameBase.prototype.cpuQuizAnswer=function(i,t,e){this._oQuizPanel.setSpectatorMode();for(var s,n=null,o=0;o<t.length;o++)t[o]===i&&(s=o);if(i<20&&(n=s,this._bBotLastAnswerWrong=!1),null===n){var a=0;for(o=0;o<e.length;o++)e[o]%10==0&&a++;i%10==0&&a++,a>1&&(n=s,this._bBotLastAnswerWrong=!1)}if(null===n)if(Math.random()<.4&&!this._bBotLastAnswerWrong){var r;console.log("TAKE WRONG ANSWER");do{r=Math.floor(Math.random()*t.length)}while(r===s);n=r,this._bBotLastAnswerWrong=!0}else this._bBotLastAnswerWrong=!1,n=s;var h=QUIZ_SHOW_COUNTDOWN+1e3+1e3*Math.random(),_=this;this._iIDTimeout=setTimeout((function(){_._oQuizPanel.setAnswer(n)}),h)},CGameBase.prototype.setCurQuizOperation=function(i){this._szCurQuizOperation=i},CGameBase.prototype._onWrongAnswer=function(){playSound("ball_saved",1,!1),this._oQuizPanel.changeMessage(TEXT_WRONG_ANSWER,"#F00"),s_iCurState===STRIKER_MODE?(this._iRemainingPlayerKicks--,this._iRemainingPlayerKicks<0&&(this._iRemainingPlayerKicks=0)):(this._iRemainingOpponentKicks--,this._iRemainingOpponentKicks<0&&(this._iRemainingOpponentKicks=0));var i=this;this._iIDTimeout=setTimeout((function(){i.hideResult(),i.changeScenario()}),TIME_SHOW_ANSWER)},CGameBase.prototype.setQuizTimeoutPanel=function(){this._onWrongAnswer(),this._oQuizPanel.changeMessage(TEXT_QUIZ_TIMEOUT,"#FFF")},CGameBase.prototype.onQuizEnd=function(i){if(i){playSound("goal_striker",1,!1),this._oQuizPanel.changeMessage(TEXT_CORRECT_ANSWER,"#68d617");var t=this;this._iIDTimeout=setTimeout((function(){t.hideResult(),t._bBonusShot=!0,s_iCurState===STRIKER_MODE?t.setBonusShotScenario():t.setBonusKeeperScenario()}),TIME_SHOW_ANSWER)}else this._onWrongAnswer()},CGameBase.prototype.setExtraPenalty=function(){this._iRemainingPlayerKicks=2,this._iRemainingOpponentKicks=2,this._oInterface.setExtraScore()},CGameBase.prototype.getCurLevel=function(){return this._iCurLevel},CGameBase.prototype.tryIncreaseStage=function(){this._iRemainingOpponentKicks===this._iRemainingPlayerKicks&&(this._iCurStage++,this._szCurQuizOperation=null)},CGameBase.prototype.getQuizTime=function(){var i=this._iCurStage;return this._iCurStage>=TIME_PER_QUIZ.length&&(i=TIME_PER_QUIZ.length),TIME_PER_QUIZ[i]},CGameBase.prototype.setQuizSpectatorMode=function(){this._oQuizPanel.setSpectatorMode()},CGameBase.prototype.checkPlayerWins=function(){return this._iPlayerGoals-this._iOpponentGoals>this._iRemainingOpponentKicks},CGameBase.prototype.checkOpponentWins=function(){return this._iOpponentGoals-this._iPlayerGoals>this._iRemainingPlayerKicks},CGameBase.prototype.checkMatchPoint=function(){var i=2;if(this._bBonusShot&&(i=1),console.log("this._bBonusShot:"+this._bBonusShot),s_iCurState===STRIKER_MODE)var t=this._iPlayerGoals+1-this._iOpponentGoals>this._iRemainingOpponentKicks,e=this._iOpponentGoals-this._iPlayerGoals>this._iRemainingPlayerKicks-i;else t=this._iPlayerGoals-this._iOpponentGoals>this._iRemainingOpponentKicks-i,e=this._iOpponentGoals+1-this._iPlayerGoals>this._iRemainingPlayerKicks;return console.log("bPlayerMatchPoint:"+t),console.log("bOpponentMatchPoint:"+e),t||e},CGameBase.prototype.checkAnyWins=function(){var i=this.checkPlayerWins(),t=this.checkOpponentWins();return i||t},CGameBase.prototype.update=function(){this._oCurScenario&&this._oCurScenario.update()};